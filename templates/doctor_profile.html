<!DOCTYPE html>
<html>
<head>
  {% load static %}
  <title>{{ doctor.name }}'s Profile - MedConnexa</title>
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(120deg, #e4f7fa, #f0f8fc);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      color: #234;
    }
    .profile-container {
      max-width: 780px;
      margin: 37px auto 24px auto;
      padding: 34px 36px 22px 36px;
      background: #fff;
      border-radius: 30px;
      box-shadow: 0 10px 24px #bfe8ee66;
      transition: box-shadow 0.18s;
    }
    .profile-main-row {
      display: flex;
      align-items: flex-start;
      gap: 32px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .photo-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px;
      margin-bottom: 0;
    }
    .doctor-photo {
      width: 120px; height: 120px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 6px 16px #bfe8ee44;
      background: #e6f4fa;
      border: 3px solid #e6f4fa;
      margin-bottom: 13px;
    }
    .default-avatar svg { width: 120px; height: 120px; border-radius: 50%; background: #e6f4fa; }
    .profile-details-col {
      flex: 1; min-width: 210px; max-width: 470px;
    }
    .profile-name {
      font-size: 1.41em; font-weight: 750; color: #189aa5; margin-bottom: 4px;
      letter-spacing: -.5px;
    }
    .profile-specialty {
      color: #1ab9c9; font-size: 1.10em; font-weight: 500; margin-bottom: 5px;
    }
    .profile-info-list {
      padding: 0; margin: 10px 0 0 0; list-style: none;
    }
    .profile-info-row {
      display: flex; align-items: center;
      gap: 12px; margin-bottom: 8px; font-size: 1.09em;
      word-break: break-word;
    }
    .profile-info-icon {
      color: #198fb1; font-size: 1.13em; min-width: 28px; text-align: right;
    }
    .profile-actions {
      display: flex; gap: 14px; flex-wrap: wrap; margin: 30px 0 12px 0; align-items: center;
    }
    .btn {
      background: linear-gradient(90deg, #4ed7e2 0%, #2ab8c2 100%);
      color: #fff;
      border: none;
      border-radius: 15px;
      padding: 12px 34px;
      font-size: 1.06em;
      text-decoration: none;
      font-weight: 500;
      box-shadow: 0 2px 8px #bfe8ee33;
      transition: background 0.13s, box-shadow 0.13s;
      min-width: 123px;
      text-align: center;
      display: inline-block;
      margin-right: 7px; margin-bottom: 3px;
      cursor: pointer;
    }
    .btn:active, .btn:focus { outline: 2px solid #e6f4fa; }
    .btn:hover { background: linear-gradient(90deg, #2ab8c2 0%, #4ed7e2 100%);}
    .badge-requested {
      display: inline-block;
      background: #e4f7fa;
      color: #aaa;
      font-weight: 600;
      font-style: italic;
      border-radius: 13px;
      padding: 12px 25px;
      margin: 0 0 3px 0;
      border: none;
      cursor: default;
      font-size: 1em;
      pointer-events: none;
      box-shadow: none;
      opacity: 0.92;
    }
    .badge-requested .fa { color: #198fb1;}
    .rating-reviews-block { margin: 18px 0 0 0;}
    .avg-rating-section {
      text-align: left; margin-bottom: 7px;
      background: #f8fcfd; border-radius: 13px;
      padding: 9px 15px; font-size: 1.15em; box-sizing: border-box;
      display: inline-block;
    }
    .stars-row {
      margin: 6px 0 2px 0; font-size: 1.7em; letter-spacing: 1.8px;
      color: gold;
    }
    .stars-row .fa-star { margin-right:0; }
    .review-list { margin: 22px 0 16px 0; }
    .review {
      margin-bottom: 17px; padding: 14px 13px;
      background: #f8fcfd; border-radius: 12px;
      box-shadow: 0 1px 5px #cbeefd18;
    }
    .review .stars-row {
      font-size: 1.13em;
      margin-bottom: 4px;
    }
    .add-review-form {
      margin: 20px 0 7px 0;
      padding: 12px 15px 15px 15px;
      border-radius: 11px;
      background: #e6f4fa;
      box-shadow: 0 1.5px 8px #bfe8ee11;
      text-align: left;
    }
    #star-rating { margin-bottom: 8px; font-size: 2.1em;}
    .star { font-size: 2em; color: #ccdff4; cursor: pointer; transition: color 0.13s;}
    .star.selected { color: gold; }
    .field-errors { color: #c00; font-size: 0.98em; margin: 4px 0 0 0;}
    .back-link { display: block; text-align:center; margin-top: 18px; color: #198fb1;
      text-decoration: none; font-size: 1em; font-weight: 500; opacity: 0.88;}
    @media (max-width:850px) {
      .profile-container { max-width: 99vw; padding: 6vw 3vw 2vw 3vw;}
      .profile-main-row { flex-direction: column; gap: 17px; justify-content: center;}
      .photo-col, .profile-details-col { min-width: 0; }
      .doctor-photo { width: 84px; height: 84px;}
      .btn { padding: 10px 18px; min-width:97px; font-size: 1em;}
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="profile-main-row">
      <div class="photo-col">
        {% if doctor.photo %}
          <img src="{{ doctor.photo.url }}" alt="Doctor Photo" class="doctor-photo">
        {% else %}
          <span class="default-avatar">
            <svg viewBox="0 0 96 96" fill="none">
              <circle cx="48" cy="48" r="48" fill="#e6f4fa"/>
              <ellipse cx="48" cy="55" rx="30" ry="28" fill="#f8fcfd"/>
              <ellipse cx="48" cy="44" rx="18" ry="15.5" fill="#ceecf2"/>
              <circle cx="48" cy="38" r="12" fill="#b2e6f7"/>
            </svg>
          </span>
        {% endif %}
      </div>
      <div class="profile-details-col">
        <div class="profile-name">{{ doctor.name }}</div>
        <div class="profile-specialty">{{ doctor.specialty }}</div>
        <ul class="profile-info-list">
          <li class="profile-info-row">
            <span class="profile-info-icon"><i class="fa fa-location-dot"></i></span>
            <span>{{ doctor.clinic_address }}</span>
          </li>
          <li class="profile-info-row">
            <span class="profile-info-icon"><i class="fa fa-calendar"></i></span>
            <span><b>Experience:</b> {{ doctor.experience_years }} year{{ doctor.experience_years|pluralize }}</span>
          </li>
          <li class="profile-info-row">
            <span class="profile-info-icon"><i class="fa fa-info-circle"></i></span>
            <span>{{ doctor.bio }}</span>
          </li>
        </ul>
        <div class="profile-actions">
          {% if user.is_authenticated and user == doctor.user %}
            <a class="btn" href="{% url 'edit_doctor' %}"><i class="fa fa-pen"></i> Edit My Profile</a>
          {% endif %}
          {% if user.is_authenticated and user.doctor != doctor %}
            {% if not connected and not connection_pending %}
              <form action="{% url 'send_connection_request' doctor.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button class="btn" type="submit"><i class="fa fa-user-plus"></i> Connect</button>
              </form>
            {% elif connection_pending %}
              <span class="badge-requested"><i class="fa fa-clock"></i> Connection Requested</span>
            {% elif connected %}
              <a class="btn" href="{% url 'chat' doctor.id %}"><i class="fa fa-comments"></i> Chat</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>

    <!-- RATING BLOCK -->
    <div class="rating-reviews-block">
      <div class="avg-rating-section">
        <b>Average Patient Rating:</b>
        <span class="stars-row">
          {% if avg_rating %}
            {% for i in "12345" %}
              <i class="fa fa-star{% if forloop.counter <= avg_rating|default:0 %}" style="color:gold;" {% else %}" style="color:#d1eaf2;" {% endif %}></i>
            {% endfor %}
            <span style="font-size:0.92em;color:#198fb1;font-weight:500;">{{ avg_rating|floatformat:1 }}/5</span>
          {% else %}
            <span style="color:#999;">Not rated yet.</span>
          {% endif %}
        </span>
      </div>
      <div class="review-list">
        <h2 style="font-size:1.04em;color:#189aa5;text-align:left; margin-bottom:6px; margin-top:10px;">Patient Reviews</h2>
        {% if reviews %}
          {% for review in reviews %}
            <div class="review">
              <div style="font-weight:500; color:#198fb1;">{{ review.reviewer_name }}</div>
              <div class="stars-row">
                {% for i in "12345" %}
                  <i class="fa fa-star{% if forloop.counter <= review.rating %}" style="color:gold;" {% else %}" style="color:#d1eaf2;" {% endif %}></i>
                {% endfor %}
                <span style="font-size:0.97em;color:#888;">
                  ({{ review.rating }}/5)
                </span>
              </div>
              <div style="margin-top:8px; font-style: italic; color:#245;">{{ review.comment }}</div>
            </div>
          {% endfor %}
        {% else %}
          <p style="color:#aaa; font-size:1em;">No reviews yet.</p>
        {% endif %}
      </div>
      <!-- Add Review -->
      <h3 style="margin-top:24px; margin-bottom:7px;">Add a Review</h3>
      <form method="post" class="add-review-form" autocomplete="off">
        {% csrf_token %}
        <div style="margin-bottom:9px;">
          <label style="display:block; margin-bottom:4px; font-weight: 500;">Your Rating:</label>
          <div id="star-rating">
            {% for i in "12345" %}
              <span class="star" data-value="{{ forloop.counter }}" title="Rate {{ forloop.counter }} out of 5">&#9733;</span>
            {% endfor %}
          </div>
          <input type="hidden" name="rating" id="star-rating-value" required>
        </div>
        <div style="margin-bottom:11px;">
          <label for="{{ form.reviewer_name.id_for_label }}" style="display:block; margin-bottom:4px;">Your Name:</label>
          {{ form.reviewer_name }}
          {% if form.reviewer_name.errors %}
            <div class="field-errors">{{ form.reviewer_name.errors.0 }}</div>
          {% endif %}
        </div>
        <div style="margin-bottom:11px;">
          <label for="{{ form.comment.id_for_label }}" style="display:block; margin-bottom:4px;">Comment:</label>
          {{ form.comment }}
          {% if form.comment.errors %}
            <div class="field-errors">{{ form.comment.errors.0 }}</div>
          {% endif %}
        </div>
        <button class="btn" type="submit" style="margin-top:4px;">Submit Review</button>
        {% if form.non_field_errors %}
          <div class="field-errors">{{ form.non_field_errors.0 }}</div>
        {% endif %}
      </form>
    </div>
    <a class="back-link" href="{% url 'home' %}">&#8592; Back to Home</a>
  </div>
  <script>
    // Only stars set the rating
    document.addEventListener('DOMContentLoaded', function(){
      const stars = document.querySelectorAll('.star');
      const input = document.getElementById('star-rating-value');
      stars.forEach(star => star.onclick = function(){
        let v=this.getAttribute('data-value');
        input.value=v;
        stars.forEach(s=>s.classList.remove('selected'));
        stars.forEach((s,i2)=>{if(i2<v)s.classList.add('selected');});
      });
      // Prevent submit without a rating
      document.querySelector("form.add-review-form").onsubmit=function(e){
        if(!input.value){
          alert("Please select a rating.");
          e.preventDefault();
        }
      };
    });
  </script>
</body>
</html>
